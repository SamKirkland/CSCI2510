#include <time.h>
#include <stdlib.h>

#include "map.pal.h"
#include "map.raw.h"
//////////////////////////////////////////////////////////////////////////////////////////////map functions
#define bool int
#define true 1
#define false 0

unsigned short *map_Map;
unsigned short *material_Map;

typedef struct tagscrollingBG {
    int xBGAhead, xBGBehind;
    int xMapAhead, xMapBehind;
    int yMapAhead, yMapBehind;
    int ulx, uly;
    int deltaX, deltaY;
    int tileUnderPlayer; // the current tile thats in map thats under the players position


    double rocketPower;
    double gravity;
    double playerVelocity;
    int terminalVelocity;
    int maxRocketVelocity;
}scrollingBG;

scrollingBG bg;

int tileToCopy, locationToPaste;
int x, y;
int mapWidthTiles, mapHeightTiles;
int screenWidth, screenHeight;
int playerXTile, playerYTile;
int emptyTiles[28] = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27};
unsigned short* bg0map;
unsigned short* bg1map;
int tilesFromTop = 0;
int xLoop, yLoop;

void setMineral(int position, int tile) {
    material_Map[position] = tile;                      // upper left
    material_Map[position+1] = tile+1;                  // upper right
    material_Map[position+mapWidthTiles] = tile+26;      // bottom left
    material_Map[position+mapWidthTiles+1] = tile+27;    // bottom right
}

void setDirt(int position) {
    int tile = 62;

    map_Map[position] = tile;                       // upper left
    map_Map[position+1] = tile+1;                   // upper right
    map_Map[position+mapWidthTiles] = tile+26;       // bottom left
    map_Map[position+mapWidthTiles+1] = tile+27;     // bottom right

    bg0map[position] = tile;                        // upper left
    bg0map[position+1] = tile+1;                    // upper right
    bg0map[position+32] = tile+26;                   // bottom left
    bg0map[position+32+1] = tile+27;                 // bottom right
}

void blackoutMinerals() {
    for (yLoop = 0; yLoop < 640; yLoop++) {
        for (xLoop = 0; xLoop < mapWidthTiles; xLoop++) {
            material_Map[xLoop + yLoop*32] = 36;
        }
    }
}

void addAllMinerals() {
    // we start at tile 28 because we dont want minerals above the surface
    for (yLoop = 28; yLoop < 640; yLoop+=2) {
        for (xLoop = 0; xLoop < 32; xLoop+=2) {
            int r = rand() % 100; // 0 and 19

            if (r == 0) {
                setMineral(xLoop + yLoop*mapWidthTiles, 42);
            }
            else if (r == 1) {
                setMineral(xLoop + yLoop*mapWidthTiles, 42);
            }
            else if (r == 2) {
                setMineral(xLoop + yLoop*mapWidthTiles, 44);
            }
            else if (r == 3) {
                setMineral(xLoop + yLoop*mapWidthTiles, 46);
            }
            else if (r == 4) {
                setMineral(xLoop + yLoop*mapWidthTiles, 48);
            }
            else if (r == 5) {
                setMineral(xLoop + yLoop*mapWidthTiles, 50);
            }
            else if (r == 6) {
                setMineral(xLoop + yLoop*mapWidthTiles, 52);
            }
            else if (r == 7) {
                setMineral(xLoop + yLoop*mapWidthTiles, 54);
            }
            else if (r == 8) {
                setMineral(xLoop + yLoop*mapWidthTiles, 56);
            }
            else if (r == 9) {
                setMineral(xLoop + yLoop*mapWidthTiles, 58);
            }
            else if (r == 10) {
                setMineral(xLoop + yLoop*mapWidthTiles, 60);
            }
		}
    }
}



const unsigned short aboveGround[1024] = {
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0001, 0x0002, 0x0003, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0004, 0x0005, 0x0006, 0x0007,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0008, 0x0009, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x000a, 0x040a, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x000a, 0x040a, 0x0000, 0x0000,
    0x0000, 0x0000, 0x000b, 0x000c, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x000d, 0x000e, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x000d, 0x000e, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0001, 0x0002,
    0x0003, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0004, 0x0005,
    0x0006, 0x0007, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x000f, 0x0010,
    0x0011, 0x0012, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0008, 0x0009, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0013, 0x0014,
    0x0015, 0x0016, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x000b, 0x000c, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x000a, 0x040a, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x000a, 0x040a, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x000d, 0x000e, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x000d, 0x000e, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x000a, 0x040a, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x000f, 0x0010, 0x0011, 0x0012, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x000d, 0x000e, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0013, 0x0014, 0x0015, 0x0016, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x000f, 0x0010, 0x0011, 0x0012,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0013, 0x0014, 0x0015, 0x0016,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x000a, 0x040a, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x000d, 0x000e, 0x0000, 0x0000,
    0x0008, 0x0009, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0001, 0x0002,
    0x0003, 0x0000, 0x0000, 0x0000, 0x0017, 0x0417, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x000b, 0x000c, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0004, 0x0005,
    0x0006, 0x0007, 0x0000, 0x0000, 0x0817, 0x0c17, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x000f, 0x0010, 0x0011, 0x0012,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0013, 0x0014, 0x0015, 0x0016,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0018, 0x0019,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x001a, 0x001a,
    0x001b, 0x001b, 0x0419, 0x0418, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0018, 0x0019, 0x001b, 0x001b, 0x001a, 0x001a,
    0x001a, 0x001a, 0x001a, 0x001a, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x001a, 0x001a, 0x001a, 0x001a, 0x001a, 0x001a,
    0x001a, 0x001a, 0x001a, 0x001a, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x001a, 0x001a, 0x001a, 0x001a, 0x001a, 0x001a,
    0x001a, 0x001a, 0x001a, 0x001a, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x001a, 0x001a, 0x001a, 0x001a, 0x001a, 0x001a,
    0x001a, 0x001a, 0x001a, 0x001a, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x001a, 0x001a, 0x001a, 0x001a, 0x001a, 0x001a,
    0x001c, 0x001d, 0x001c, 0x001d, 0x001c, 0x001d, 0x001e, 0x001f,
    0x001e, 0x001f, 0x001e, 0x001f, 0x001e, 0x001f, 0x001e, 0x001f,
    0x001e, 0x001f, 0x001e, 0x001f, 0x001e, 0x001f, 0x001e, 0x001f,
    0x001c, 0x001d, 0x001c, 0x001d, 0x001c, 0x001d, 0x001c, 0x001d,
    0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021,
    0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021,
    0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021,
    0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021,
    0x0022, 0x0023, 0x0022, 0x0023, 0x0022, 0x0023, 0x0022, 0x0023,
    0x0022, 0x0023, 0x0022, 0x0023, 0x0022, 0x0023, 0x0022, 0x0023,
    0x0022, 0x0023, 0x0022, 0x0023, 0x0022, 0x0023, 0x0022, 0x0023,
    0x0022, 0x0023, 0x0022, 0x0023, 0x0022, 0x0023, 0x0022, 0x0023,
    0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021,
    0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021,
    0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021,
    0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021, 0x0020, 0x0021,
    0x0022, 0x0023, 0x0022, 0x0023, 0x0022, 0x0023, 0x0022, 0x0023,
    0x0022, 0x0023, 0x0022, 0x0023, 0x0022, 0x0023, 0x0022, 0x0023
};
void generateMap() {
    // generate dirt/cloud map
    int i = 0;
    for (i = 0; i < 30*32; i++) {
        map_Map[i] = aboveGround[i];
    }


    int xLoop, yLoop;
    for (yLoop = 32; yLoop <= 640; yLoop += 2) {
        for (xLoop = 0; xLoop < 32; xLoop += 2) {
            int currentPosition = mapWidthTiles*yLoop + xLoop;
            
            map_Map[currentPosition] = 32;
            map_Map[currentPosition+1] = 33;
            map_Map[currentPosition+mapWidthTiles] = 34;
            map_Map[currentPosition+mapWidthTiles+1] = 35;
        }
    }


    // generate mineral map
    blackoutMinerals();
    addAllMinerals();
}

void loadStartingPosition() {
    // DMAFastCopy((void*)map_Palette, (void*)BGPaletteMem, 256, DMA_16NOW);

    for (yLoop = 0; yLoop < 32; yLoop++) {
        for (xLoop = 0; xLoop < 32; xLoop++) {
            bg0map[xLoop + yLoop*32] = map_Map[xLoop + yLoop*mapWidthTiles]; // xLoop + 16
            bg1map[xLoop + yLoop*32] = material_Map[xLoop + yLoop*mapWidthTiles]; // xLoop + 16
        }
    }
}


bool isTileOpen(int tileToCheck) {
    int i = 0;
    for (i = 0; i < sizeof(emptyTiles)/sizeof(emptyTiles[0]); i++) {
        if (map_Map[tileToCheck] == emptyTiles[i]) {
            return true;
        }
    }
    return false;
}

// returns true if the tile is open
bool checkDirection(char direction[]) {
    int tileToCompare = bg.tileUnderPlayer; // compare current tile

    if (strcmp(direction, "top") == 0) { // top
        tileToCompare -= mapWidthTiles;
    }
    else if (strcmp(direction, "right") == 0) { // right
        tileToCompare += 2;
    }
    else if (strcmp(direction, "bottom") == 0) { // bottom
        tileToCompare += mapWidthTiles;
    }
    else if (strcmp(direction, "left") == 0) { // left
        tileToCompare -= 2;
    }

    return isTileOpen(tileToCompare);
}
